#!/usr/bin/env node
'use strict'

var program = require('commander')
var shell = require('shelljs')
var path = require('path')
var packageObj = require('../package')
var fs = require('fs')


function read(versionFile) {
  // 同步读取
  if (fs.existsSync(versionFile)) {
    return fs.readFileSync(versionFile).toString().trim()
  }
  return ''
}

function resolveProjectPath(f) {
  return path.resolve(__dirname, '../' + f)
}

function resolveDistPath(f) {
  return resolveProjectPath('dist/' + f)
}

var nwjsVersion = read(resolveProjectPath('nwjs_v'))
var packageVersion = read(resolveProjectPath('package_v'))

program
  .version(packageObj.version + '/package ' + packageVersion  + '/nwjs ' + nwjsVersion)
  .usage('[--debug [port]]')
  .description('启动微信web开发者工具')
  .option('-D, --debug [port]', '开启debug模式', /^[1-9]\d{1,3}$/)
  .option('--install', '安装桌面图标和替换兼容性wcc/wcsc', /^[1-9]\d{1,3}$/)
  .parse(process.argv)

if (program.install || !read(resolveDistPath('installed'))) {
  console.log('第一次运行')
  console.log('安装桌面图标')
  shell.exec(resolveProjectPath('scripts/install_desktop.sh'))
  console.log('替换兼容性wcc/wcsc')
  shell.exec(resolveProjectPath('scripts/install_weapp_vendor.sh'))
  console.log('安装完成')

  fs.writeSync(resolveDistPath('installed'), '1')
}

var execCommon = resolveDistPath('nw')
if (program.debug) {
  var port = program.debug === true
    ? 9222
    : program.debug

  execCommon += ' --remote-debugging-port=' + port
  console.info('remote-debugging-port@' + port)
}

shell.exec(execCommon)
