#!/usr/bin/env node
'use strict'

var program = require('commander')
var shell = require('shelljs')
var path = require('path')
var packageObj = require('../package')
var fs = require('fs')


function getVersion(versionFile) {
  // 同步读取
  var nwjs = path.resolve(__dirname, '../' + versionFile)
  if (fs.existsSync(nwjs)) {
    return fs.readFileSync(nwjs).toString().trim()
  }
  return ''
}

var nwjsVersion = getVersion('nwjs_v')
var packageVersion = getVersion('package_v')
var currentNwjsVersion = getVersion('dist/nwjs_version')

program
  .version(packageObj.version + '/package ' + packageVersion  + '/nwjs ' + nwjsVersion)
  .usage('[--debug [port]]')
  .description('启动微信web开发者工具')
  .option('-D, --debug [port]', '开启debug模式', /^[1-9]\d{1,3}$/)
  .parse(process.argv)

if (currentNwjsVersion !== nwjsVersion) {
  console.log('安装微信开发者工具对应nwjs版本：$nwjs_v')
  shell.exec(path.resolve(__dirname, '../scripts/install_nwjs.sh'))
  shell.exec(path.resolve(__dirname, '../scripts/install_weapp_vendor.sh'))
  console.log('安装完成')
}

if (currentNwjsVersion === '') {
  shell.exec(path.resolve(__dirname, '../scripts/install_desktop.sh'))
}

var execCommon = path.resolve(__dirname, '../dist/nw')
if (program.debug) {
  var port = program.debug === true
    ? 9222
    : program.debug

  execCommon += ' --remote-debugging-port=' + port
  console.info('remote-debugging-port@' + port)
}

shell.exec(execCommon)
