#!/usr/bin/env node
'use strict'

var program = require('commander')
var shell = require('shelljs')
var path = require('path')
var packageObj = require('../package')
var fs = require('fs')


function getVersion(versionFile) {
  // 同步读取
  if (fs.existsSync(versionFile)) {
    return fs.readFileSync(versionFile).toString().trim()
  }
  return ''
}


function resolveProjectPath(f) {
  return path.resolve(__dirname, '../' + f)
}


function resolveDistPath(f) {
  return path.resolve(process.env.HOME, '.wechat_dev_tools/' + f)
}

var nwjsVersion = getVersion(resolveProjectPath('nwjs_v'))
var packageVersion = getVersion(resolveProjectPath('package_v'))

program
  .version(packageObj.version + '/package ' + packageVersion  + '/nwjs ' + nwjsVersion)
  .usage('[--debug [port]]')
  .description('启动微信web开发者工具')
  .option('-D, --debug [port]', '开启debug模式', /^[1-9]\d{1,3}$/)
  .option('--install', '强制安装一次')
  .parse(process.argv)

var currentNwjsVersion = getVersion(resolveDistPath('nwjs_version'))

if (currentNwjsVersion !== nwjsVersion || program.install) {
  console.log('安装微信开发者工具对应nwjs版本：$nwjs_v')
  shell.exec(resolveProjectPath('scripts/install_nwjs.sh'))
  shell.exec(resolveProjectPath('scripts/install_weapp_vendor.sh'))
  console.log('安装完成')
}

if (currentNwjsVersion === '') {
  shell.exec(resolveProjectPath('scripts/install_desktop.sh'))
}

if (program.install) {
  shell.exit(0)
}

var execCommon = resolveDistPath('nw')
if (program.debug) {
  var port = program.debug === true
    ? 9222
    : program.debug

  execCommon += ' --remote-debugging-port=' + port
  console.info('remote-debugging-port@' + port)
}

shell.exec(execCommon)
